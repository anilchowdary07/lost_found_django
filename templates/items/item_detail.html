{% extends 'base.html' %}

{% block title %}{{ item.title }} - Campus Lost & Found{% endblock %}

{% block extra_css %}
<style>
            .item-detail-main-card {
                position: relative;
                background: linear-gradient(135deg, #fff 80%, #f1f5fa 100%);
                border: 1.5px solid #e0e7ef;
                box-shadow: 0 8px 32px rgba(2,6,23,0.13);
                border-radius: 28px;
                padding: 2.7rem 2.7rem 2.2rem 2.7rem;
                margin-bottom: 2.5rem;
                transition: box-shadow 0.2s, transform 0.2s;
                overflow: hidden;
            }
            .item-detail-main-card:hover {
                box-shadow: 0 12px 36px rgba(99,102,241,0.13), 0 2px 8px rgba(2,6,23,0.10);
                transform: translateY(-2px) scale(1.01);
            }
            .item-detail-main-card > *:not(:first-child) {
                margin-top: 1.5rem;
            }
            @media (max-width: 991px) {
                .item-detail-main-card {
                    padding: 1.2rem 0.7rem;
                }
            }
        body {
            background: linear-gradient(135deg, #f8fafc 0%, #e0e7ef 100%) !important;
        }
        .item-detail-main-card {
            box-shadow: 0 8px 32px rgba(2,6,23,0.13);
            border-radius: 24px;
            padding: 2.5rem 2.5rem 2rem 2.5rem;
            background: #fff;
            margin-bottom: 2.5rem;
        }
        @media (max-width: 991px) {
            .item-detail-main-card {
                padding: 1.2rem 0.7rem;
            }
        }
        .item-image {
            margin-bottom: 2rem;
        }
        .item-image {
            background: #f8fafc;
            min-height: 320px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.2rem;
        }
        .item-image img, .item-image-placeholder {
            width: 100%;
            max-width: 100%;
            max-height: 420px;
            min-height: 180px;
            object-fit: contain;
            background: transparent;
            display: block;
            margin: 0 auto;
            border-radius: 18px;
            box-shadow: none;
        }
        @media (max-width: 768px) {
            .item-image {
                min-height: 160px;
                padding: 0.5rem;
            }
            .item-image img, .item-image-placeholder {
                min-height: 80px;
                max-height: 220px;
            }
        }
        @media (max-width: 768px) {
            .item-image img, .item-image-placeholder {
                height: 220px;
            }
        }
        .timeline {
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            font-size: 1.08rem;
        }
        .timeline-item {
            padding: 1.3rem 1.2rem;
            font-size: 1.08rem;
        }
        .related-items-section {
            margin-top: 3.5rem;
            padding: 2rem 1.2rem 1.2rem 1.2rem;
            background: #f1f5fa;
            border-radius: 18px;
            box-shadow: 0 2px 12px rgba(99,102,241,0.07);
        }
        .related-items-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1.2rem;
        }
    .related-items-section {
        margin-top: 2.5rem;
    }
    .related-items-title {
        font-size: 1.2rem;
        font-weight: 700;
        margin-bottom: 1rem;
    }
    .related-items-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem;
    }
    .related-item-card {
        border-radius: 14px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        background: #fff;
        overflow: hidden;
        transition: box-shadow 0.2s, transform 0.2s;
        cursor: pointer;
    }
    .related-item-card:hover {
        box-shadow: 0 6px 18px rgba(99,102,241,0.13);
        transform: translateY(-2px) scale(1.03);
    }
    .related-item-img {
        width: 100%;
        height: 110px;
        object-fit: cover;
        background: #f1f5f9;
    }
    .related-item-title {
        font-size: 1rem;
        font-weight: 600;
        margin: 0.5rem 0.7rem 0.7rem 0.7rem;
        color: #334155;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .item-image {
        position: relative;
        overflow: hidden;
        border-radius: 18px;
        box-shadow: 0 8px 32px rgba(2,6,23,0.10);
        margin-bottom: 1rem;
    }
    .item-image img {
        width: 100%;
        height: 400px;
        object-fit: cover;
        transition: transform 0.3s cubic-bezier(.4,2,.6,1);
        cursor: pointer;
        border-radius: 18px;
    }
    .item-image:hover img {
        transform: scale(1.07);
    }
    .item-image-placeholder {
        height: 400px;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border-radius: 18px;
        color: #64748b;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
    }
    @media (max-width: 768px) {
        .item-image img,
        .item-image-placeholder {
            height: 220px;
        }
    }
    .status-badge {
        font-size: 0.8rem;
        padding: 0.35rem 0.8rem;
        border-radius: 16px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        margin-bottom: 0.25rem;
    }
    .item-tag {
        background: #e0e7ff;
        color: #3730a3;
        padding: 0.3rem 0.8rem;
        border-radius: 16px;
        font-size: 0.85rem;
        font-weight: 600;
        margin-right: 0.3rem;
        margin-bottom: 0.3rem;
        display: inline-block;
    }
    .sticky-action-bar {
        position: sticky;
        top: 0;
        z-index: 1050;
        background: rgba(255,255,255,0.97);
        box-shadow: 0 2px 12px rgba(0,0,0,0.04);
        padding: 0.75rem 1rem;
        display: flex;
        gap: 1rem;
        align-items: center;
        border-radius: 0 0 18px 18px;
        margin-bottom: 1.5rem;
        animation: fadeInDown 0.7s;
    }
    @keyframes fadeInDown {
        from { opacity: 0; transform: translateY(-30px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .btn-share {
        background: #f1f5f9;
        color: #334155;
        border: none;
        border-radius: 12px;
        padding: 0.6rem 1.2rem;
        font-weight: 600;
        transition: background 0.2s;
    }
    .btn-share:hover {
        background: #e0e7ef;
        color: #1e293b;
    }
    .timeline-item {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        padding: 1rem;
        border-left: 3px solid #e2e8f0;
        position: relative;
        margin-bottom: 1rem;
        background: #f8fafc;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    }
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -7px;
        top: 1.5rem;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #6366f1;
    }
    .timeline-marker {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        flex-shrink: 0;
        background: #6366f1;
        color: #fff;
        box-shadow: 0 2px 8px rgba(99,102,241,0.12);
    }
    .timeline-content h6 {
        margin: 0 0 0.25rem 0;
        font-weight: 700;
        color: #1e293b;
    }
    .timeline-content small {
        color: #64748b;
    }
    .claim-section {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border: 1px solid #f59e0b;
        border-radius: 16px;
        padding: 1.5rem;
        margin-top: 1.5rem;
        box-shadow: 0 2px 8px rgba(245,158,11,0.08);
    }
    .action-buttons {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-top: 1.5rem;
    }
    .btn-claim {
        background: linear-gradient(90deg, #f59e0b, #d97706);
        color: white;
        border: none;
        padding: 0.85rem 2rem;
        border-radius: 12px;
        font-weight: 700;
        font-size: 1.1rem;
        transition: all 0.3s cubic-bezier(.4,2,.6,1);
        box-shadow: 0 2px 8px rgba(245,158,11,0.12);
    }
    .btn-claim:hover {
        background: linear-gradient(90deg, #d97706, #b45309);
        transform: translateY(-2px) scale(1.03);
        box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        color: white;
    }
</style>
{% endblock %}

{% block content %}

<!-- Sticky Action Bar -->
<div class="sticky-action-bar shadow-sm mb-3">
    <a href="{% url 'items:dashboard' %}" class="btn btn-outline-secondary"><i class="fas fa-arrow-left me-1"></i>Back</a>
    {% if can_claim %}
    <button class="btn btn-claim claim-btn" data-item-id="{{ item.id }}" data-item-title="{{ item.title }}">
        <i class="fas fa-hand-holding-heart me-1"></i>Claim This Item
    </button>
    {% endif %}
    <button class="btn btn-share" id="shareBtn" onclick="copyItemLink(event)"><i class="fas fa-share-alt me-1"></i>Share</button>
</div>
        <!-- Related Items Section -->
        <div class="related-items-section">
            <div class="related-items-title"><i class="fas fa-link me-1"></i>Related Items</div>
            <div class="related-items-grid">
                {% for related in related_items %}
                <a href="{% url 'items:item_detail' related.id %}" class="related-item-card">
                    {% if related.image_url %}
                    <img src="{{ related.image_url }}" class="related-item-img" alt="{{ related.title }}">
                    {% else %}
                    <div class="related-item-img d-flex align-items-center justify-content-center text-muted" style="font-size:2rem;">üì¶</div>
                    {% endif %}
                    <div class="related-item-title">{{ related.title }}</div>
                </a>
                {% empty %}
                <div class="text-muted">No related items found.</div>
                {% endfor %}
            </div>
        </div>

<!-- Hidden form for CSRF token -->
<form style="display: none;">
    {% csrf_token %}
</form>

<div class="row">
    <div class="col-md-8">
        <div class="item-detail-main-card">
            {% if item.image_url %}
            <div class="item-image">
                <img src="{{ item.image_url }}" class="card-img-top img-large" alt="{{ item.title }}" data-bs-toggle="modal" data-bs-target="#imageModal">
            </div>
            {% else %}
            <div class="item-image-placeholder d-flex align-items-center justify-content-center">
                <span class="fs-1">üì¶</span>
            </div>
            {% endif %}
            
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h1 class="card-title mb-2">{{ item.title }}</h1>
                        <div class="d-flex gap-2 flex-wrap">
                            <span class="badge bg-info status-badge">{{ item.get_category_display }}</span>
                            <span class="badge status-badge {% if item.status == 'reported' %}bg-secondary{% elif item.status == 'claimed' %}bg-warning{% elif item.status == 'verified' %}bg-info{% else %}bg-success{% endif %}">
                                {{ item.get_status_display }}
                            </span>
                            {% if item.item_type %}
                            <span class="badge bg-primary status-badge">{{ item.get_item_type_display }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="d-flex gap-2 flex-wrap">
                        {% if can_edit %}
                        <a href="{% url 'items:edit_item' item.id %}" class="btn btn-outline-primary">
                            <i class="fas fa-edit me-1"></i>Edit Item
                        </a>
                        {% endif %}
                        {% if can_claim %}
                        <button class="btn btn-claim claim-btn" data-item-id="{{ item.id }}" data-item-title="{{ item.title }}">
                            <i class="fas fa-hand-holding-heart me-1"></i>Claim This Item
                        </button>
                        {% endif %}
                        {% if user.is_authenticated and not can_edit %}
                        <button type="button" class="btn btn-outline-warning btn-sm" onclick="openFlagModal()">
                            <i class="fas fa-flag me-1"></i>Flag Content
                        </button>
                        {% endif %}
                    </div>
                </div>

                {% if item.description %}
                <div class="mb-4">
                    <h5 class="text-muted mb-2">Description</h5>
                    <p class="card-text fs-6">{{ item.description }}</p>
                </div>
                {% endif %}

                <div class="row mb-4">
                    <div class="col-md-6">
                        <h5 class="text-muted mb-2">Location & Details</h5>
                        <div class="mb-2">
                            <i class="fas fa-map-marker-alt text-muted me-2"></i>
                            <span>{{ item.location }}</span>
                        </div>
                        {% if item.latitude and item.longitude %}
                        <div class="mb-2">
                            <i class="fas fa-globe text-muted me-2"></i>
                            <small class="text-muted">Coordinates: {{ item.latitude|floatformat:4 }}, {{ item.longitude|floatformat:4 }}</small>
                        </div>
                        {% endif %}
                        <div class="mb-2">
                            <i class="fas fa-calendar text-muted me-2"></i>
                            <small class="text-muted">Reported: {{ item.created_at|date:"M d, Y \a\t H:i" }}</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5 class="text-muted mb-2">Reported By</h5>
                        <div class="d-flex align-items-center">
                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                <i class="fas fa-user"></i>
                            </div>
                            <div>
                                <div class="fw-semibold">{{ item.user.get_full_name|default:item.user.username }}</div>
                                <small class="text-muted">@{{ item.user.username }}</small>
                            </div>
                        </div>
                    </div>
                </div>

                {% if item.ai_tags %}
                <div class="mb-4">
                    <h5 class="text-muted mb-2">AI-Generated Tags</h5>
                    <div>
                        {% for tag in item.ai_tags %}
                        <span class="item-tag">{{ tag }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if claim %}
                <div class="alert alert-warning mt-3">
                    <h5><i class="fas fa-hand-holding-heart me-2"></i>Item Claimed</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Claimed by:</strong> {{ claim.claimer.get_full_name|default:claim.claimer.username }}</p>
                            <p class="mb-1"><strong>Claimed at:</strong> {{ claim.claimed_at|date:"M d, Y \\a\\t H:i" }}</p>
                        </div>
                        {% if claim.message %}
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Message:</strong></p>
                            <p class="text-muted fst-italic">{{ claim.message }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                {% if claims_history and claims_history|length > 0 %}
                <div class="mt-4">
                    <h5 class="text-muted mb-2"><i class="fas fa-history me-2"></i>Claim History</h5>
                    <ul class="list-group">
                        {% for c in claims_history %}
                        <li class="list-group-item d-flex flex-column flex-md-row justify-content-between align-items-md-center">
                            <div>
                                <strong>{{ c.claimer.get_full_name|default:c.claimer.username }}</strong>
                                <span class="badge bg-secondary ms-2">{{ c.get_status_display }}</span>
                                <br>
                                <small class="text-muted">Claimed at: {{ c.claimed_at|date:"M d, Y H:i" }}</small>
                                {% if c.message %}<br><span class="text-muted fst-italic">"{{ c.message }}"</span>{% endif %}
                            </div>
                            <div class="mt-2 mt-md-0">
                                {% if c.accepted_at %}<span class="badge bg-success">Accepted</span>{% endif %}
                                {% if c.rejected_at %}<span class="badge bg-danger">Rejected</span>{% endif %}
                            </div>
                        </li>
                        {% empty %}
                        <li class="list-group-item text-muted">No claims yet.</li>
                        {% endfor %}
                    </ul>
                </div>

                {% if can_edit %}
                <div class="action-buttons">
                    {% if item.status == 'claimed' %}
                    <button class="btn btn-success" onclick="markItemReturned()">
                        <i class="fas fa-check-circle me-1"></i>Mark as Returned
                    </button>
                    {% endif %}
                    {% if item.status != 'returned' %}
                    <button class="btn btn-primary" onclick="generateQRCode()">
                        <i class="fas fa-qrcode me-1"></i>Generate QR Code
                    </button>
                    {% endif %}
                    {% if claim and claim.status in 'pending,accepted' %}
                    <button type="button" class="btn btn-outline-danger" onclick="openDisputeModal()">
                        <i class="fas fa-gavel me-1"></i>Create Dispute
                    </button>
                    {% endif %}
                </div>
                {% endif %}

                {% elif can_claim %}
                <div class="claim-section">
                    <h5 class="mb-2"><i class="fas fa-info-circle me-2"></i>Is this your item?</h5>
                    <p class="mb-3 text-muted">Click the "Claim This Item" button above to submit a claim. The owner will be notified and can share their contact information with you.</p>
                    <div class="alert alert-light border">
                        <small><strong>Contact Method:</strong> After claiming, you'll receive the owner's email address ({{ item.user.email }}) to arrange pickup.</small>
                    </div>
                </div>
                {% endif %}

                {% if item.status == 'returned' and claim %}
                <div class="alert alert-success mt-3">
                    <h5><i class="fas fa-check-circle me-2"></i>Item Successfully Returned</h5>
                    <p class="mb-0"><strong>Returned at:</strong> {{ claim.verified_at|date:"M d, Y \a\t H:i" }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card" style="box-shadow:0 4px 18px rgba(99,102,241,0.10);border-radius:18px;">
            <div class="card-header bg-light">
                <h5 class="mb-0">üìä Status Timeline</h5>
            </div>
            <div class="card-body">
                <h5 class="mb-3"><i class="fas fa-history me-2"></i>Status Timeline</h5>
                <div class="timeline">
                    {% for event in timeline %}
                    <div class="timeline-item">
                        <div class="timeline-marker bg-{% if event.status == 'reported' %}secondary{% elif event.status == 'claimed' %}warning{% elif event.status == 'verified' %}info{% else %}success{% endif %} text-white">
                            {% if event.status == 'reported' %}üìù
                            {% elif event.status == 'claimed' %}‚úã
                            {% elif event.status == 'verified' %}‚úì
                            {% else %}‚úì‚úì
                            {% endif %}
                        </div>
                        <div class="timeline-content">
                            <h6>{{ event.get_status_display }}</h6>
                            <small class="text-muted d-block">{{ event.changed_at|date:"M d, Y \a\t H:i" }}</small>
                            {% if event.notes %}
                            <small class="text-muted d-block">{{ event.notes }}</small>
                            {% endif %}
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-4">
                        <i class="fas fa-clock text-muted fa-2x mb-2"></i>
                        <p class="text-muted mb-0">No timeline events yet</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        {% if can_edit and claim and item.status != 'returned' %}
        <div class="card mt-3">
            <div class="card-header bg-light">
                <h5 class="mb-0">üîê QR Code Handover</h5>
            </div>
            <div class="card-body">
                <p class="text-muted small">Generate a unique QR code to securely verify the item handover when meeting in person.</p>
                <div id="qrCodeContainer" class="text-center hidden">
                    <img id="qrCodeImage" src="" alt="QR Code" class="qr-image">
                    <p class="mt-2"><small class="text-muted" id="qrCodeId"></small></p>
                </div>
                <button class="btn btn-primary w-100" onclick="generateQRCode()" id="generateQRBtn">Generate QR Code</button>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
function copyItemLink(e) {
    e.preventDefault();
    const url = window.location.href;
    // Try Clipboard API first
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(url).then(function() {
            showToast('Link copied to clipboard!', 'success');
        }, function() {
            fallbackCopyTextToClipboard(url);
        });
    } else {
        fallbackCopyTextToClipboard(url);
    }
}

function fallbackCopyTextToClipboard(text) {
    // Create a temporary textarea to select/copy
    var textArea = document.createElement("textarea");
    textArea.value = text;
    // Avoid scrolling to bottom
    textArea.style.position = "fixed";
    textArea.style.top = 0;
    textArea.style.left = 0;
    textArea.style.width = '2em';
    textArea.style.height = '2em';
    textArea.style.padding = 0;
    textArea.style.border = 'none';
    textArea.style.outline = 'none';
    textArea.style.boxShadow = 'none';
    textArea.style.background = 'transparent';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    try {
        var successful = document.execCommand('copy');
        if (successful) {
            showToast('Link copied to clipboard!', 'success');
        } else {
            showToast('Failed to copy link', 'error');
        }
    } catch (err) {
        showToast('Failed to copy link', 'error');
    }
    document.body.removeChild(textArea);
}
}
function showGlobalSpinner(show) {
    const spinner = document.getElementById('globalSpinner');
    if (!spinner) return;
    spinner.style.display = show ? 'flex' : 'none';
}
{% if claim %}
async function generateQRCode() {
    const btn = document.getElementById('generateQRBtn');
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Generating...';
    showGlobalSpinner(true);
    try {
        const response = await fetch('{% url "items:generate_qr_code" claim.id %}');
        const data = await response.json();
        showGlobalSpinner(false);
        if (data.success) {
            document.getElementById('qrCodeImage').src = data.qr_code;
            document.getElementById('qrCodeId').textContent = 'Code: ' + data.qr_id;
            document.getElementById('qrCodeContainer').style.display = 'block';
            showToast('QR code generated successfully!', 'success');
            btn.innerHTML = 'QR Code Generated ‚úì';
        } else {
            throw new Error(data.error || 'Failed to generate QR code');
        }
    } catch (error) {
        showGlobalSpinner(false);
        showToast('Error: ' + error.message, 'error');
        btn.disabled = false;
        btn.innerHTML = 'Generate QR Code';
    }
}

function markItemReturned() {
    if (confirm('Mark this item as returned? This will award karma points to the finder.')) {
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        showGlobalSpinner(true);
        fetch('{% url 'items:mark_item_returned' item.id %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            showGlobalSpinner(false);
            if (data.success) {
                showToast(data.message, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast('Error: ' + data.error, 'error');
            }
        })
        .catch(error => { showGlobalSpinner(false); showToast('Error: ' + error, 'error'); });
    }
}


{% endif %}
</script>
<script>
// Toast function - define first before other functions use it
function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer') || createToastContainer();
    const typeClass = type === 'error' ? 'danger' : type;
    const typeIcon = type === 'error' ? '‚úï' : type === 'success' ? '‚úì' : '‚Ñπ';
    const typeTitle = type === 'error' ? 'Error' : type === 'success' ? 'Success' : 'Info';
    
    const toastHTML = `
        <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-${typeClass}">
                <strong class="me-auto text-white">${typeIcon} ${typeTitle}</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHTML);
    const toastElement = toastContainer.lastElementChild;
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
    
    toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toastContainer';
    container.className = 'position-fixed top-0 end-0 p-3';
    container.style.zIndex = '11000';
    document.body.appendChild(container);
    return container;
}

function removeModalBackdrop() {
    // Force remove all backdrop elements
    document.querySelectorAll('.modal-backdrop').forEach(el => {
        el.style.display = 'none';
        el.style.opacity = '0';
        el.style.pointerEvents = 'none';
        el.remove();
    });
    
    // Force remove modal-open class and styles
    document.body.classList.remove('modal-open');
    document.body.style.paddingRight = '';
    document.body.style.overflow = '';
    
    // Additional cleanup - check for any lingering backdrop elements
    setTimeout(() => {
        document.querySelectorAll('[class*="modal-backdrop"]').forEach(el => {
            el.style.display = 'none';
            el.style.pointerEvents = 'none';
            el.remove();
        });
    }, 50);
    
    // Force CSS refresh
    document.body.style.transform = 'translateZ(0)';
    requestAnimationFrame(() => {
        document.body.style.transform = '';
    });
}

function cleanupAllModals() {
    document.querySelectorAll('.modal').forEach(modal => {
        try {
            const instance = bootstrap.Modal.getInstance(modal);
            if (instance) {
                instance.hide();
            }
        } catch (e) {}
    });
    removeModalBackdrop();
}

// Enhanced modal cleanup - run periodically
function forceModalCleanup() {
    if (!document.querySelector('.modal.show')) {
        removeModalBackdrop();
    }
}

// Global modal event handler
document.addEventListener('DOMContentLoaded', function() {
    // Clean up any existing backdrops on page load
    removeModalBackdrop();
    
    // Monitor for modal state changes
    setInterval(forceModalCleanup, 1000);
    
    // Enhanced event listeners for all modals
    document.addEventListener('hidden.bs.modal', function() {
        setTimeout(removeModalBackdrop, 100);
    });
    
    document.addEventListener('hide.bs.modal', function() {
        setTimeout(removeModalBackdrop, 50);
    });
    
    // Handle ESC key globally
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            setTimeout(removeModalBackdrop, 100);
        }
    });
});
</script>

<!-- Claim Item Modal -->
{% if can_claim %}
<div class="modal fade" id="claimModal" tabindex="-1" aria-labelledby="claimModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="claimModalLabel">Claim Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="claimForm">
                {% csrf_token %}
                <div class="modal-body">
                    <p class="text-muted mb-3">
                        Claiming <strong id="modalItemTitle"></strong>
                    </p>
                    <div class="mb-3">
                        <label for="claimMessage" class="form-label">Message (Optional)</label>
                        <textarea class="form-control" id="claimMessage" name="message" rows="3" placeholder="Tell the owner how to recognize you or arrange pickup..."></textarea>
                        <small class="text-muted">Your email will be shared with the owner once they accept your claim.</small>
                    </div>
                    <input type="hidden" id="itemIdInput" name="item_id" value="">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="claimSubmitBtn">Submit Claim</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const claimModal = document.getElementById('claimModal');
    
    claimModal.addEventListener('hidden.bs.modal', function() {
        removeModalBackdrop();
    });
    
    document.querySelectorAll('.claim-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            removeModalBackdrop();
            const itemId = this.dataset.itemId;
            const itemTitle = this.dataset.itemTitle;
            
            document.getElementById('itemIdInput').value = itemId;
            document.getElementById('modalItemTitle').textContent = itemTitle;
            document.getElementById('claimMessage').value = '';
            
            const modal = new bootstrap.Modal(claimModal);
            modal.show();
        });
    });

    document.getElementById('claimForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const itemId = document.getElementById('itemIdInput').value;
        const message = document.getElementById('claimMessage').value;
        const submitBtn = document.getElementById('claimSubmitBtn');
        
        if (message.length > 1000) {
            showToast('Message cannot exceed 1000 characters', 'error');
            return;
        }
        
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';
        
        try {
            const formData = new FormData();
            formData.append('item_id', itemId);
            formData.append('message', message);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            const response = await fetch('{% url "items:claim_item" %}', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Failed to claim item');
            }
            
            showToast('Item claimed successfully! The owner will be notified.', 'success');
            removeModalBackdrop();
            
            try {
                const instance = bootstrap.Modal.getInstance(claimModal);
                if (instance) instance.hide();
            } catch (e) {}

            setTimeout(() => location.reload(), 1500);
            
        } catch (error) {
            showToast(error.message, 'error');
            removeModalBackdrop();
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Submit Claim';
        }
    });
});
</script>
{% endif %}

<!-- Image Modal -->
{% if item.image_url %}
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">{{ item.title }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <img src="{{ item.image_url }}" class="w-100" alt="{{ item.title }}" style="max-height: 80vh; object-fit: contain;">
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const imageModal = document.getElementById('imageModal');
    
    imageModal.addEventListener('hidden.bs.modal', function() {
        removeModalBackdrop();
    });
});
</script>
{% endif %}

<!-- Flag Content Modal -->
<div class="modal fade" id="flagModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Report Inappropriate Content</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Reason</label>
                    <select id="flagReason" class="form-select">
                        <option value="">-- Select a reason --</option>
                        <option value="inappropriate">Inappropriate Content</option>
                        <option value="spam">Spam</option>
                        <option value="misleading">Misleading Information</option>
                        <option value="offensive">Offensive Language</option>
                        <option value="fraud">Suspected Fraud</option>
                        <option value="duplicate">Duplicate Listing</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea id="flagDescription" class="form-control" rows="4" placeholder="Explain why you're reporting this..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="submitFlag">Report</button>
            </div>
        </div>
    </div>
</div>

{% if claim and user.is_authenticated and user == claim.item.user %}
<!-- Create Dispute Modal -->
<div class="modal fade" id="disputeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Dispute</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3">
                    <strong>‚ö†Ô∏è Note:</strong> Creating a dispute will escalate this claim to our admin team for review.
                </div>
                <div class="mb-3">
                    <label class="form-label">Reason for Dispute</label>
                    <textarea id="disputeReason" class="form-control" rows="4" placeholder="Explain why you're disputing this claim..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="submitDispute">Create Dispute</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
function openFlagModal() {
    const flagModal = new bootstrap.Modal(document.getElementById('flagModal'));
    flagModal.show();
}

function openDisputeModal() {
    const disputeModal = new bootstrap.Modal(document.getElementById('disputeModal'));
    disputeModal.show();
}

document.getElementById('submitFlag').addEventListener('click', async function() {
    const reason = document.getElementById('flagReason').value;
    const description = document.getElementById('flagDescription').value;
    
    if (!reason || !description) {
        showToast('Please select a reason and provide a description', 'error');
        return;
    }
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    try {
        const response = await fetch('{% url "items:flag_content" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken,
            },
            body: `item_id={{ item.id }}&reason=${reason}&description=${encodeURIComponent(description)}`
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showToast('Thank you! We\'ll review this content shortly.', 'success');
            bootstrap.Modal.getInstance(document.getElementById('flagModal')).hide();
        } else {
            showToast('Error: ' + data.error, 'error');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
});

{% if claim %}
document.getElementById('submitDispute').addEventListener('click', async function() {
    const reason = document.getElementById('disputeReason').value;
    
    if (!reason) {
        showToast('Please provide a reason for the dispute', 'error');
        return;
    }
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    try {
        const response = await fetch('{% url "items:create_dispute" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken,
            },
            body: `claim_id={{ claim.id }}&reason=${encodeURIComponent(reason)}`
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showToast('Dispute created! Admin will review it shortly.', 'success');
            bootstrap.Modal.getInstance(document.getElementById('disputeModal')).hide();
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast('Error: ' + data.error, 'error');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
});
{% endif %}

function showToast(message, type) {
    const toastHtml = `<div class="toast" role="alert">
        <div class="toast-body bg-${type === 'error' ? 'danger' : 'success'} text-white">
            ${message}
        </div>
    </div>`;
    
    const container = document.querySelector('.toast-container') || document.createElement('div');
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.innerHTML = toastHtml;
    document.body.appendChild(container);
    
    const toast = new bootstrap.Toast(container.querySelector('.toast'));
    toast.show();
}
</script>

{% endblock %}
